name: VPS Health Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check VPS Health
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          echo "ğŸ¥ Running health checks..."
          
          cd /opt/presetshop
          
          echo "ğŸ“Š Container Status:"
          docker-compose -f docker-compose.prod.yml ps
          
          echo ""
          echo "ğŸ’¾ Resource Usage:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
          
          echo ""
          echo "ğŸ’¿ Disk Usage:"
          df -h /opt/presetshop
          docker system df
          
          echo ""
          echo "ğŸ” Service Health:"
          curl -f http://localhost/ || echo "âŒ Frontend/Nginx failed"
          curl -f http://localhost/api/health || echo "âŒ Backend failed"
          
          echo ""
          echo "âœ… Health check complete!"
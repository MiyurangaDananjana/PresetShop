name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        envs: DOCKER_USERNAME,DOCKER_PASSWORD,DOCKER_REGISTRY
        script: |
          set -e
          
          echo "üìÅ Navigating to application directory..."
          cd /opt/presetshop || exit 1
          
          echo "üîê Logging into Docker Hub..."
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          
          echo "üì• Pulling latest Docker images..."
          docker pull ${DOCKER_REGISTRY}/presetshop-backend:latest
          docker pull ${DOCKER_REGISTRY}/presetshop-frontend:latest
          
          echo "üõë Stopping old containers..."
          docker-compose -f docker-compose.prod.yml down || true
          
          echo "üöÄ Starting new containers..."
          docker-compose -f docker-compose.prod.yml up -d
          
          echo "‚è≥ Waiting for services to start..."
          sleep 15
          
          echo "‚úÖ Container status:"
          docker-compose -f docker-compose.prod.yml ps
          
          echo "üè• Health checks:"
          echo "Database:"
          docker exec presetshop-db-1 pg_isready -U presetshop_user || echo "DB not ready"
          
          echo "Backend:"
          curl -f http://localhost:8080/api/health || echo "Backend not ready"
          
          echo "Frontend:"
          curl -f http://localhost:3000 || echo "Frontend not ready"
          
          echo "Nginx:"
          curl -f http://localhost/health || echo "Nginx not ready"
          
          echo "üßπ Cleaning up unused images..."
          docker image prune -f
          
          echo "üéâ Deployment completed successfully!"